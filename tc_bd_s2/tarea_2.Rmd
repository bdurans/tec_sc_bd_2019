---
title: "Tarea 2"
author: "Curso Big Data TEC"
date: "20191214"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Tarea sesión 2

## Descripción tarea
Lleva los datos ejemplo a una base de datos NoSQL de uno de los siguientes tipos (cualquier derivado comercial vale).

 - Key-Value Store
 - Document Store
 - Graph Database

Puedes escojer la tecnologia que quieras. La mayoría optó por trabajar con los datos de gobierno. Si eres una de las personas que no, por favor contacta al profesor para decidir sobre cuales datos vas a  trabajar.

Documenta el proces en un documento RMarkdown, y despues usando la base de datos seleccionaste ejecuta los siguientes queries, dejando el código dentro del documento RMarkdown.

 - Una lista de la cantidad de entradas por nacionalidad
 - Para cada punto de entrada las 3 nacionalidades que entran y salen 

## Entrega

Antes de entregar has un render (knit) de tu Rmarkdown. Entrega por favor el HTML y el .Rmd por tec digital.

Si trabajas con los datos de gobierno tienes completa disponibilidad de

    https://movmigcr.ixpantia.com

Para hacer incluir un repositorio propio dentro del proyecto para trabajar.



```{r}
library(nodbi)
library(sofa)
library(dplyr)
library(feather)
```

```{r}
# -------------------------------------------
# Sofa package
# Create a CouchDB connection client
(couchdb_conn <- Cushion$new(user="admin", pwd="admin"))
# Creates the database
db_create(couchdb_conn, "mov_mig_cr")

  # -------------------------------------------
# nodbi package
files <- list.files("mov_mig_cr_parts", full.names = TRUE)
df <- read.csv(files[2])
# creates connection to CouchDB
src <- src_couchdb(user="admin", pwd="admin")

doc <- docdb_create(src, key="mov_mig_cr", value=df)
# Load CSV parts to mongo


for (file in files) {
  print(file)
}

```

```{r}
result <- docdb_query(src, "mov_mig_cr", query = 'http://127.0.0.1:5984/mov_mig_cr/_design/migrations/_view/find?limit=10')
```

```{r}
test<- result %>%
  group_by(NAC_ID) %>%
  count()
```

```{r}
# Standalone connection
# conf <- spark_config()
# conf$spark.executor.memory <- "2GB"
# conf$spark.memory.fraction <- 0.9
# conf$spark.executor.cores <- 2
# conf$spark.dynamicAllocation.enabled <- "false"

# sc <- spark_connect(master="spark://master-url:7077", 
#              version = "2.1.0",
#              config = conf,
#              spark_home = "/opt/spark/")
```

```{r}
sc <- spark_connect(master = "local")
```

```{r}
dtf <- read_feather("D:\\Documents\\mov_mig_cr\\mov_mig_cr.feather")
```


```{r}
order_by_nac_id <- dtf %>%
  filter(DET_MOV_CICLO_MIGRATORIO == "E") %>%
  group_by(NAC_ID) %>%
  count()
```


```{r}
entries_immigration_check_post <- dtf %>%
  filter(DET_MOV_CICLO_MIGRATORIO == "E") %>%
  group_by(PUE_ID_PUESTO_MIGRATORIO, NAC_ID) %>%
  summarize(total = n()) %>%
  arrange(desc(total), .by_group = TRUE, ) %>%
  top_n(n = 3, wt = total)

entries_immigration_check_post
```

```{r}
exits_immigration_check_post <- dtf %>%
  filter(DET_MOV_CICLO_MIGRATORIO == "S") %>%
  group_by(PUE_ID_PUESTO_MIGRATORIO, NAC_ID) %>%
  summarize(total = n()) %>%
  arrange(desc(total), .by_group = TRUE, ) %>%
  top_n(n = 3, wt = total)

exits_immigration_check_post
```
